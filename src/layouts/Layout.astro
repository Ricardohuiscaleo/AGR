---
// 1. Usar ChatInterfaceDarkWrapper que monta ChatInterfaceDarkLegacy
import ChatInterfaceDarkWrapper from '../components/ChatInterfaceDarkWrapper.astro';
interface Props {
  title: string;
  description?: string;
}

const { title, description } = Astro.props;
---

<!doctype html>
<html lang="es" class="dark">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg?v=2" />
    <!-- Prevenir solicitudes autom치ticas de apple-touch-icon -->
    <link rel="apple-touch-icon" href="/compressed/logo-oscuro-optimizado.png" />
    <link rel="apple-touch-icon-precomposed" href="/compressed/logo-oscuro-optimizado.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    {description && <meta name="description" content={description} />}
    <!-- p5.js library from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.2/p5.min.js"></script>

    <!-- Font Awesome para iconos del chat -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- Estilos m칤nimos para corregir el chat -->
    <style>
      /* Correcciones m칤nimas para el chat en m칩vil */
      #chat-interface-dark-container textarea {
        max-height: 80px !important;
        min-height: 40px !important;
        resize: none !important;
      }
    </style>
  </head>
  <body class="dark:bg-[#ece6dc] bg-[#ece6dc]">
    <!-- Contenedor principal del sitio -->
    <slot />
    


    <!-- Full-screen chat modal -->
    <div id="full-screen-chat-modal" class="full-screen-chat-modal-hidden">
      <div class="full-screen-chat-modal-content">
        <!-- 2. ChatInterfaceDarkWrapper que monta ChatInterfaceDarkLegacy -->
        <ChatInterfaceDarkWrapper />
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        // --- L칍GICA PARA ABRIR Y CERRAR EL MODAL ---
        const fullScreenChatModal = document.getElementById('full-screen-chat-modal');

        // Funci칩n para abrir el modal
        function openChatModal() {
          if (fullScreenChatModal) {
            fullScreenChatModal.classList.remove('full-screen-chat-modal-hidden');
            fullScreenChatModal.classList.add('full-screen-chat-modal-visible');
            document.body.style.overflow = 'hidden';
            document.body.classList.add('modal-open'); // Agregar clase para m칩viles

            // Forzar rec치lculo de altura en m칩vil
            if (window.visualViewport) {
              fullScreenChatModal.style.height = `${window.visualViewport.height}px`;
            }

            // Focus en el input del chat despu칠s de un peque침o delay
            setTimeout(() => {
              const chatInput = document.querySelector('#chat-interface-dark-container textarea');
              if (chatInput && chatInput instanceof HTMLElement) {
                chatInput.focus();
              }
            }, 300);
          }
        }

        // Funci칩n para cerrar el modal
        function closeChatModal() {
          if (fullScreenChatModal) {
            fullScreenChatModal.classList.remove('full-screen-chat-modal-visible');
            fullScreenChatModal.classList.add('full-screen-chat-modal-hidden');
            document.body.style.overflow = '';
            document.body.classList.remove('modal-open'); // Remover clase para m칩viles

            // Resetear altura
            fullScreenChatModal.style.height = '';
          }
        }

        // Event listeners - S칔PER SIMPLE
        document.addEventListener('openChatModal', (event) => {
          console.log('游눞 Abriendo chat Gaby Legacy');
          openChatModal();
        });

        // Bot칩n cerrar ahora est치 dentro del componente React

        // Cerrar con ESC
        document.addEventListener('keydown', (e) => {
          if (
            e.key === 'Escape' &&
            fullScreenChatModal &&
            fullScreenChatModal.classList.contains('full-screen-chat-modal-visible')
          ) {
            closeChatModal();
          }
        });

        // --- MANEJO MEJORADO DEL TECLADO M칍VIL ---
        const visualViewport = window.visualViewport;

        if (visualViewport) {
          visualViewport.addEventListener('resize', () => {
            if (
              fullScreenChatModal &&
              fullScreenChatModal.classList.contains('full-screen-chat-modal-visible')
            ) {
              // Ajustar altura del modal
              fullScreenChatModal.style.height = `${visualViewport.height}px`;

              // Scroll al final del chat cuando aparece el teclado
              setTimeout(() => {
                const messagesArea = fullScreenChatModal.querySelector(
                  '.flex-grow.p-4.overflow-y-auto'
                );
                if (messagesArea) {
                  messagesArea.scrollTop = messagesArea.scrollHeight;
                }
              }, 100);
            }
          });
        }

        // Prevenir scroll en background cuando el modal est치 abierto
        fullScreenChatModal?.addEventListener(
          'touchmove',
          (e) => {
            if (e.target === fullScreenChatModal) {
              e.preventDefault();
            }
          },
          { passive: false }
        );
      });
    </script>
  </body>
</html>

<style is:global>
  /* --- ESTILOS GLOBALES --- */
  /* Clase personalizada para pantallas extra peque침as */
  @media (min-width: 400px) {
    .xs\:inline {
      display: inline;
    }
  }
  :root {
    --background-color: #ece6dc;
    --accent: 136, 58, 234;
    --accent-light: 224, 204, 250;
    --accent-dark: 49, 10, 101;
    --accent-gradient: linear-gradient(
      45deg,
      rgb(var(--accent)),
      rgb(var(--accent-light)) 30%,
      white 60%
    );
  }

  html {
    font-family: system-ui, sans-serif;
    background: var(--background-color);
    background-size: 224px;
    scroll-behavior: smooth;
    transition: background-color 0.3s ease-in-out;
  }

  body {
    margin: 0;
    padding: 0;
    min-height: 100vh;
    background-color: var(--background-color);
    transition: background-color 0.3s ease-in-out;
    overflow-x: hidden;
  }

  .layout-container {
    position: relative;
    z-index: 10;
  }

  * {
    box-sizing: border-box;
  }

  /* Asegurar que el texto sea seleccionable en toda la aplicaci칩n */
  p,
  h1,
  h2,
  h3,
  h4,
  h5,
  h6,
  span,
  div,
  li,
  a,
  label,
  input,
  textarea,
  th,
  td {
    user-select: text !important;
  }

  /* Chat component interactivity fixes */
  .chat-astro-wrapper,
  .chat-astro-wrapper *,
  .chat-container,
  .chat-container * {
    pointer-events: auto !important;
  }

  .chat-input,
  .chat-input *,
  #userInput {
    font-size: 16px !important;
    pointer-events: auto !important;
  }

  /* Animaciones Keyframes */
  @keyframes planeFlight {
    0% {
      transform: rotate(0deg);
    }
    25% {
      transform: rotate(-40deg);
    }
    50% {
      transform: rotate(10deg);
    }
    75% {
      transform: rotate(-40deg);
    }
    100% {
      transform: rotate(0deg);
    }
  }

  @keyframes typing-dynamic {
    from {
      width: 0;
    }
    to {
      width: var(--target-width);
    }
  }

  @keyframes erase-dynamic {
    from {
      width: var(--target-width);
    }
    to {
      width: 0;
    }
  }

  @keyframes hide-caret {
    from {
      border-right-color: #007bff;
    }
    to {
      border-right-color: transparent;
    }
  }

  @keyframes typingBlink {
    0%,
    100% {
      opacity: 1;
      transform: scale(1);
    }
    50% {
      opacity: 0.3;
      transform: scale(1.2);
    }
  }

  @keyframes shimmer {
    from {
      background-position: 200% 0;
    }
    to {
      background-position: -200% 0;
    }
  }

  /* ==================================================================== */
  /* === ESTILOS DEL MODAL FULLSCREEN (LA PARTE CORREGIDA Y SIMPLIFICADA) === */
  /* ==================================================================== */
  #full-screen-chat-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100dvh;
    background: rgba(17, 24, 39, 0.85);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    z-index: 10010;
    display: flex;
    justify-content: center;
    align-items: center;
    transition:
      opacity 0.3s,
      visibility 0.3s;
    /* Prevenir scroll en iOS */
    touch-action: none;
    -webkit-overflow-scrolling: touch;
  }

  .full-screen-chat-modal-hidden {
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
  }

  .full-screen-chat-modal-visible {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
  }

  .full-screen-chat-modal-content {
    position: relative;
    width: 100%;
    height: 100%;
    max-width: 900px;
    display: flex;
    flex-direction: column;
    /* Sin padding - contenedor limpio */
    overflow: hidden;
  }

  /* Estilos espec칤ficos para m칩viles */
  @media (max-width: 767px) {
    #full-screen-chat-modal {
      align-items: stretch; /* Ocupar toda la altura en m칩vil */
    }

    .full-screen-chat-modal-content {
      height: 100vh;
      height: 100dvh; /* Usar dynamic viewport height */
      max-height: none;
    }

    /* Asegurar que el textarea tenga el tama침o correcto en m칩viles */
    #chat-interface-dark-container textarea {
      font-size: 16px !important; /* Prevenir zoom en iOS */
      -webkit-appearance: none;
      border-radius: 0;
    }

    /* Mejorar el scroll en el 치rea de mensajes */
    #chat-interface-dark-container .flex-grow.p-4.overflow-y-auto {
      -webkit-overflow-scrolling: touch;
      overflow-scrolling: touch;
    }
  }

  /* Media Query para PANTALLAS M츼S GRANDES (PC) */
  @media (min-width: 768px) {
    .full-screen-chat-modal-content {
      height: 90vh;
      max-height: 800px;
      border-radius: 1rem;
      overflow: hidden;
      box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.4);
    }
  }

  /* Correcciones adicionales para el chat */
  #chat-interface-dark-container {
    height: 100% !important;
    overflow: hidden;
  }

  /* ESTRUCTURA CORRECTA DEL CHAT */
  #chat-interface-dark-container {
    height: 100% !important;
    overflow: hidden !important;
    display: flex !important;
    flex-direction: column !important;
  }

  /* Asegurar que el componente React hijo tenga la estructura correcta */
  #chat-interface-dark-container > div {
    width: 100% !important;
    height: 100% !important;
    display: flex !important;
    flex-direction: column !important;
  }

  /* SOLUCI칍N M칍VIL COMPLETA */
  @media (max-width: 767px) {
    /* Fijar el modal para que no se mueva con el teclado virtual */
    #full-screen-chat-modal {
      position: fixed !important;
      height: 100vh !important;
      height: 100dvh !important;
    }

    /* Evitar que el contenedor del chat cambie de tama침o */
    #chat-interface-dark-container {
      height: 100vh !important;
      height: 100dvh !important;
      max-height: 100vh !important;
      max-height: 100dvh !important;
      overflow: hidden !important;
    }

    /* Asegurar que el contenedor interno mantenga su estructura */
    #chat-interface-dark-container > div {
      height: 100% !important;
      max-height: 100% !important;
      position: relative !important;
      overflow: hidden !important;
    }

    /* Fijar el 치rea de input en la parte inferior SIN sticky */
    #chat-interface-dark-container .flex-shrink-0:last-child {
      position: absolute !important;
      bottom: 0 !important;
      left: 0 !important;
      right: 0 !important;
      background: #111827 !important;
      z-index: 10 !important;
      border-top: 1px solid #111827 !important;
      margin: 0 !important;
      padding-bottom: 0 !important;
    }

    /* Eliminar margen del contenedor del textarea */
    #chat-interface-dark-container .flex-shrink-0:last-child > div {
      margin: 0 !important;
      padding-bottom: 0 !important;
    }

    /* Eliminar margen del 치rea de input */
    #chat-interface-dark-container .flex-shrink-0:last-child .p-4 {
      padding-bottom: 8px !important;
    }

    /* Ajustar el 치rea de mensajes para que no se superponga con el input */
    #chat-interface-dark-container .flex-grow {
      padding-bottom: 100px !important;
      height: calc(100% - 100px) !important;
      overflow-y: auto !important;
    }

    /* Textarea con comportamiento desktop en m칩vil */
    #chat-interface-dark-container textarea {
      font-size: 16px !important;
      min-height: 16px !important;
      max-height: 80px !important;
      resize: none !important;
    }

    /* Bot칩n cerrar sin borde en m칩vil */
    #chat-interface-dark-container .flex-shrink-0:first-child button {
      border: none !important;
      position: relative !important;
    }
  }

  /* Asegurar que los botones del chat funcionen correctamente */
  .send-button-dark,
  .quick-button-dark,
  #full-screen-chat-modal-close {
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }
</style>
